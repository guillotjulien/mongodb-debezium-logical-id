# Mongo Debezium logical ID extraction

This repository contains a simple reproduction of a Debezium connector listening to a MongoDB change stream events
and publishing those in a Kafka topic.

The goal is to configure our connector in a way such that insert, update, delete and tombstone messages uses `user_id`
as the message key instead of the default `_id` that is automatically generated by MongoDB.

## Quick Start

1. Start the containers: `docker compose up -d`
2. Start the Debezium connector: `docker compose exec -it kafka /opt/bitnami/kafka/bin/connect-standalone.sh /bitnami/kafka/config/connect-standalone.properties /bitnami/kafka/config/connect-mongo-users.properties`
3. Start the console consumer: `docker compose exec -it kafka /opt/bitnami/kafka/bin/kafka-console-consumer.sh --bootstrap-server localhost:9092 --topic data.test.users --property print.key=true --property print.value=true --property key.separator="="`
4. Connect to the local MongoDB deployment: `mongosh test`
5. Create the users collection: `db.createCollection('users', { changeStreamPreAndPostImages: { enabled: true } })`
6. Run some Mongo operations and observe the output of the console consumer:

```js
// 1. insert a record
db.users.insertOne({ user_id: 1 }) // Will print {"user_id":1}={"_id":"...","user_id":1,"__deleted":false,"__op":"c","__ts_ms":...}

// 2. update record
db.users.updateOne({ user_id: 1 }, { $set: { roles: ['ADMIN'] } }) // Will print {"_id":"...","user_id":1,"roles":{"_0":"ADMIN"},"__deleted":false,"__op":"u","__ts_ms":...}

// 3. delete record
db.users.deleteOne({ user_id: 1 })

// Will print 2 messages (one for the delete, one for the tombstone):
// {"user_id":1}={"_id":"...","user_id":1,"roles":{"_0":"ADMIN"},"__deleted":true,"__op":"u","__ts_ms":...}
// {"id":"..."}=null
```

## Open questions

Can we create a custom SMT that replaces the document content with `null` **after** extracting the key? 

So essentially:
1. ExtractNewDocumentState
2. ValueToKey
3. ConvertDeleteToTombstone <-- the custom SMT
